---
title: "Housing: Denmark"
author: "Christian Kruse"
date: "`r Sys.Date()`"
output: html_document
---

```{r housing_dk}
knitr::opts_chunk$set(echo = TRUE,include=TRUE,messsage=TRUE)
options(scipen=999)

```

```{r }
if (!require(pacman)) { install.packages("pacman") }
pacman::p_load(tidyr,
               dplyr,
               ggplot2,
               boot,
               openxlsx,
               lubridate,
               forcats,
               broom,
               purrr,
               caret,
               glue,
               devtools,
               gam,
               TTR,
               dkstat,
               httr,
               rvest,
               zoo,
               rvest)
source(file = "money_theme.R")


```

# Housing: Denmark

```{r}
message("one")
```

```{r gam_adjust}
gam_adjust = function(data) {
  message("one")
  print("one")
  
  # grid <- expand.grid(span = seq(0.1, 0.5, len = 10), degree = c(1))
  # fit_gam = suppressWarnings(expr =  { train(y = data$VALUE, 
  #       x = data %>% dplyr::select(DATE),
  #       tuneGrid=grid,
  #       method = "gamLoess") })
  print("two")
  
  fit_smooth = caret::train(y = data$VALUE,
                            x = data %>% dplyr::select(DATE) %>% as.data.frame(),
                            method="gamLoess")
  # fit_smooth = suppressWarnings(expr =  { caret::train(y = data$VALUE, 
  #                           x = data %>% dplyr::select(DATE), 
  #                           method="gamLoess",
  #                           tuneGrid=grid,
  #                           trControl=trainControl(method = "repeatedcv",number = 5,repeats = 1)) })
  
  print("three")
  data %>% 
    dplyr::mutate(VALUE_SMOOTH=predict(fit_smooth,.))# %>%
    # dplyr::mutate(VALUE_SMOOTH_SCALED=scale(VALUE_SMOOTH,center=TRUE,scale=TRUE)) %>%
    # dplyr::mutate(VALUE_SCALED=scale(VALUE,center=TRUE,scale=TRUE)) %>%
    # dplyr::mutate(VALUE_EMA=TTR::EMA(VALUE,20)) %>% 
    # arrange(desc(DATE)) %>% 
    # dplyr::mutate(VALUE_CHG=VALUE-lead(VALUE)) %>% 
    # filter(!is.na(VALUE_CHG)) %>% 
    # arrange((DATE)) %>% 
    # dplyr::mutate(VALUE_SUM_CHG=cumsum(VALUE_CHG)) %>% 
    # dplyr::mutate(VALUE_SUM_CHG_SCALED=scale(VALUE_SUM_CHG,center=TRUE,scale=TRUE))
  
}
```


```{r dst_1a}
BYGV80_meta <- dst_meta(table = "BYGV80", lang = "da")
```


```{r dst_1b}
BYGV80 <- dst_get_data(table = "BYGV80", 
                       BYGFASE="*",
                       ANVENDELSE="*",
                       Tid="*",
                       lang = "da") %>% 
  group_by(BYGFASE,ANVENDELSE) %>% 
  arrange(BYGFASE,ANVENDELSE,TID) %>% 
  filter(ANVENDELSE %in% c("Etageboliger","Parcelhuse")) %>% 
  dplyr::mutate(ANVENDELSE=gsub("Etageboliger","FLAT",ANVENDELSE)) %>% 
  dplyr::mutate(ANVENDELSE=gsub("Parcelhuse","HOUSE",ANVENDELSE)) %>% 
  dplyr::rename(PROPERTY_TYPE=ANVENDELSE) %>% 
  dplyr::rename(STAT=BYGFASE) %>% 
  dplyr::rename(DATE=TID) %>% 
  dplyr::rename(VALUE=value) %>% 
  group_by(PROPERTY_TYPE,STAT) %>% 
  dplyr::mutate(PROPERTY_TYPE=recode(PROPERTY_TYPE, 'HOUSE'='Parcel-/rækkehuse', 'FLAT'='Ejerlejlighed'))
```


```{r datasubset}
data = BYGV80 %>% filter(PROPERTY_TYPE=="Parcel-/rækkehuse",STAT=="Tilladt byggeri")
```

```{r caret}
library(caret)
```

```{r message=FALSE}
message(data)
```

```{r message=FALSE}
print(data)
```


```{r gam_model}
gam(VALUE~DATE,data=data)
```

```{r lm}
lm(VALUE~DATE,data=data)
```


```{r fitsmooth,message = TRUE,warning = TRUE,include = TRUE,results = TRUE,error=TRUE}
  # fit_smooth = 
  caret::train(y = as.numeric(data$VALUE),
               x = data %>% dplyr::select(DATE) %>% dplyr::mutate(DATE=as.Date(DATE)) %>% as.data.frame(),
               method="gam",
               metric="RMSE")
```


