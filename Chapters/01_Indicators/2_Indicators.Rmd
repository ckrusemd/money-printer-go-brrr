---
title: "Indicators"
author: "Christian Kruse"
date: "4/6/2022"
output: html_document
---

```{r  include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
options(scipen=999)
```

```{r}

if (!require(pacman)) { install.packages("pacman") }
pacman::p_load(fredr,
               dplyr,
               tidyr,
               lubridate,
               caret,
               partykit,
               pROC,
               gganimate,
               devtools,
               irr,
               httr,
               data.table,
               pROC,
               rPref,
               progress,
               quantmod,
               rvest,
               ggrepel)
source(file = "money_theme.R")
```

# Indicators

```{r }
readRenviron(path = "Renviron.site")
fredr::fredr_set_key(key = Sys.getenv("FRED_API"))
```

```{r}

add_fomc_meeting_dates = function() {
  geom_vline(xintercept = c(ymd("2022-06-15"),
                            ymd("2022-07-27"),
                            ymd("2022-09-21"),
                            ymd("2022-11-02"),
                            ymd("2022-12-14"),
                            ymd("2023-02-01"),
                            ymd("2023-03-15"),
                            ymd("2023-05-03"),
                            ymd("2023-06-14"),
                            ymd("2023-07-26"),
                            ymd("2023-09-20"),
                            ymd("2023-11-01"),
                            ymd("2023-12-13"),
                            ymd("2024-01-31"),
                            ymd("2024-03-20"),
                            ymd("2024-05-01"),
                            ymd("2024-06-19"),
                            ymd("2024-07-31"),
                            ymd("2024-09-25")),linetype=2,color="#eb493a")
}
```


## FRED Data

```{r}
series_ids = unique(c("CBBTCUSD",
               "NASDAQCOM",
               "T10Y2Y",
               "T5YIFR",
               "BAA10Y",
               "T10Y3M",
               "CPIAUCSL",
               "DCOILWTICO",
               "DFF",
               "ACTLISCOUUS",
               "MORTGAGE30US",
               "COMPUTSA",
               "RRVRUSQ156N",
               "UMCSENT",
               "BAMLH0A0HYM2",
               "RHORUSQ156N",
               "T10YIE",
               "HOUST1F",
               "BAMLH0A0HYM2",
               "COMPU1USA",
               "M2V",
               "BAMLC0A4CBBB",
               "PCEPI",
               "AUTHNOTT",
               "PSAVERT",
               "RRPONTSYD",
               "PERMIT",
               "M1SL",
               "PERMIT1",
               "T10Y3M",
               "INDPRO",
               "BAMLC0A4CBBB",
               "NFCI",
               "CORESTICKM159SFRBATL",
               "PAYEMS",
               "CIVPART",
               "MDSP",
               "M2SL",
               "UNRATE",
               "AUTHNOT1U",
               "HOUST",
               "ICSA",
               "DGS10",
               "DGS20",
               "DGS30",
               "DGS5",
               "DGS2",
               "DGS1",
               "CSUSHPINSA",
               "GDP",
               "GDPC1",
               "DFII10",
               "TDSP",
               "WALCL",
               "MSPUS"))

df_series = rbindlist(lapply(series_ids,function(series_id) {
  fredr::fredr_series_observations(series_id = series_id) %>% 
  dplyr::select(date,value) %>% 
    dplyr::mutate(series_id=series_id) %>% 
    tidyr::complete(date=seq.Date(from=min(date,na.rm=T),to=Sys.Date(),by="1 day")) %>% 
    tidyr::fill(value,.direction = "down")  %>% 
    tidyr::fill(series_id,.direction = "down") 
}))
```

## Yahoo Data

```{r}
series_ids_yahoo = unique(c("AAPL",
                            "JNJ",
                            "MSFT",
                            "GC=F",
                            "SI=F",
                            "DX-Y.NYB",
                            "BTC-USD",
                            "ETH-USD",
                            "PA=F",
                            "GOLD",
                            "FCX",
                            "SH",
                            "^OMXC25",
                            "SPY",
                            "QQQ",
                            "IWM",
                            "SH",
                            "PSQ",
                            "RWM",
                            "TMV",
                            "TQQQ",
                            "IGOV",
                            "BWX",
                            "ISHG",
                            "BUND",
                            "GLD",
                            "IAU",
                            "SGOL",
                            "UUP",
                            "USO",
                            "SSO",
                            "TBT",
                            "GBTC",
                            "ETHO",
                            "TLT",
                            "USDDKK=X"))

df_yahoo = rbindlist(lapply(series_ids_yahoo,function(ticker) {
      temp_df = getSymbols(ticker, env = NULL) %>% 
      as.data.frame(.) %>% 
      dplyr::mutate(Date=row.names(.)) %>% 
      dplyr::mutate(Date=gsub("X","",Date)) %>% 
      dplyr::mutate(Date=ymd(Date)) %>% 
      dplyr::select(c(7,1)) %>% 
      setNames(.,c("date","value")) %>% 
      dplyr::mutate(series_id=ticker) %>% 
      tidyr::complete(date=seq.Date(from=min(date,na.rm=T),to=Sys.Date(),by="1 day")) %>% 
      tidyr::fill(value,.direction = "down")  %>% 
      tidyr::fill(series_id,.direction = "down") 
      
      row.names(temp_df) = NULL
      return( temp_df )
}))
```

### Combinations

```{r}
df_series = bind_rows( df_series , df_yahoo )
series_ids = unique(df_series$series_id)
```


```{r}
combinations = data.frame(t(combn(series_ids,2)))
combinations = expand.grid(x1=series_ids,
            x2=series_ids) %>% 
  filter(x1!=x2)
combinations.list <- split(combinations, seq(nrow(combinations)))

```

# Cross correlations

```{r}

calc_ccf = function(data) {
  ccf_results = ccf(data$value.x,data$value.y,lag.max = 1,plot = FALSE)
  best_corr_index = which(abs(ccf_results$acf)==max(abs(ccf_results$acf)))
  best_corr_time = ccf_results$lag[best_corr_index]
  best_corr_value = ccf_results$acf[best_corr_index]
  data.frame(best_corr_time,best_corr_value)
}
df_ccfs = combinations %>% 
  inner_join(df_series,by=c("x1"="series_id")) %>% 
  inner_join(df_series,by=c("x2"="series_id","date"="date")) %>% 
  dplyr::select(-date) %>% 
  na.omit() %>% 
  group_by(x1,x2) %>% 
  do(calc_ccf(.))

df_ccfs %>% 
  ggplot(.,aes(x=best_corr_time,y=best_corr_value)) +
  geom_point() +
  geom_vline(xintercept = 0,linetype=2) +
  geom_hline(yintercept = 0,linetype=2) +
  scale_y_continuous(limits = c(-1,1),breaks = seq(-1,1,by=0.1)) +
  scale_x_continuous(breaks = seq(-10,10,by=1)*365,labels=seq(-10,10,by=1))
```


```{r}

df_ccf = df_series %>%
  filter(series_id %in% c("TBT","TLT")) %>% 
  spread(series_id,value) %>% 
  na.omit() %>% 
  setNames(.,c("Dates","One","Two"))
ccf_results = ccf(df_ccf$One,df_ccf$Two,lag.max = 3650)
best_corr_index = which(abs(ccf_results$acf)==max(abs(ccf_results$acf)))
best_corr_time = ccf_results$lag[best_corr_index]
best_corr_value = ccf_results$acf[best_corr_index]

```

```{r}

df_ccf = df_series %>%
  filter(series_id %in% c("BTC-USD","TLT")) %>% 
  spread(series_id,value) %>% 
  na.omit() %>% 
  setNames(.,c("Dates","One","Two"))
ccf_results = ccf(df_ccf$One,df_ccf$Two,lag.max = 3650)
best_corr_index = which(abs(ccf_results$acf)==max(abs(ccf_results$acf)))
best_corr_time = ccf_results$lag[best_corr_index]
best_corr_value = ccf_results$acf[best_corr_index]

```

```{r}

function(series_1,series_2,time_lag) {
  
  df_series %>%
    filter(series_id %in% c("CSUSHPINSA","MORTGAGE30US")) %>% 
    dplyr::mutate(date=case_when(series_id==series_1 ~ date+time_lag,
                                 TRUE ~ date)) %>% 
    spread(series_id,value) %>% 
    na.omit() %>% 
    setNames(.,c("Dates","One","Two")) %>% 
    lm(One~Two,data=.) %>% 
    summary(.)
    predict(.,data.frame(Two=6.5))
  
}

df_ccf_lm = df_series %>%
  filter(series_id %in% c("CSUSHPINSA","MORTGAGE30US")) %>% 
  spread(series_id,value) %>% 
  na.omit() %>% 
  setNames(.,c("Dates","One","Two"))
ccf_results = ccf(df_ccf$One,df_ccf$Two,lag.max = 3650)
best_corr_index = which(abs(ccf_results$acf)==max(abs(ccf_results$acf)))
best_corr_time = ccf_results$lag[best_corr_index]
best_corr_value = ccf_results$acf[best_corr_index]
```

